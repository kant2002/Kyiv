using Система.Лінкью;
using static Kyiv.Конвертер;

namespace Kyiv;

public class Декомпілятор
{
    public static string Декомпілювати(string команда)
    {
        var лістінг = ПарсерЛістінга.ПрочитатиІзРядка(команда);
        return Декомпілювати(лістінг);
    }

    public static string Декомпілювати(Лістінг лістінг)
    {
        List<string> команди = new List<string>();
        List<int> точкиПереходу = new();
        foreach (var (лінія, адреса) in лістінг.ОдиниціКоду.ВибратиБагато(ок => ок.Команди.Вибрати((к, а) => (к, ок.ПочатковаАдреса + а))))
        {
            var команда = ПарсерКоманд.Розібрати(лінія);
            switch (команда.Код)
            {
                case КодОперації.СравнениеБезУчетаЗнаков:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.СравнениеСУчетомЗнаков:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.ТочноеСравнение:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.ВыводКодов:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.ЗаписьНаМагнитныйБарабанКодовИзЯчеекЗапоминающегоУстройств:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.ЧтениеКодовСМагнитногоБарабанаВЯчейкиЗапоминающегоУстройства:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.УсловныйПереходНаПодпрограмму:
                    точкиПереходу.Add(команда.Адреса2);
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.НачалоГрупповойОперации:
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.ОкончаниеГрупповойОперации:
                    точкиПереходу.Add(команда.Адреса2);
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                case КодОперації.УсловныйПереходПоЗнакуЧисла:
                    точкиПереходу.Add(команда.Адреса2);
                    точкиПереходу.Add(команда.Адреса3);
                    break;
                default:
                    break;
            }
        }

        foreach (var (лінія, адреса) in лістінг.ОдиниціКоду.ВибратиБагато(ок => ок.Команди.Вибрати((к, а) => (к, ок.ПочатковаАдреса + а))))
        {
            try
            {
                var мітка = точкиПереходу.Contains(адреса) ? new string[] { $"lbl_{До8РічноїАдреси(адреса)}:" } : [];
                команди.AddRange(мітка.Обєднати(
                    ДоАссемблера(ПарсерКоманд.Розібрати(лінія), true)
                        .Вибрати(ВставитиЗмінні)
                        .Вибрати(ДоРядка)));
            }
            catch
            {
                команди.Add("// Невідома команда " + ПарсерКоманд.Сконвертувати(лінія));
            }
        }

        return string.Join(Environment.NewLine, команди);
    }
    private static Операція ВставитиЗмінні(Операція операція)
    {
        return ПерезаписатиВирази(операція, ПерезаписатиАдреси);
        static Вираз ПерезаписатиАдреси(Вираз вираз)
        {
            return вираз switch
            {
                УнарнаОперація унарна => new УнарнаОперація(унарна.Тип, ПерезаписатиАдреси(унарна.Вираз)),
                БінарнаОперація бінарна => new БінарнаОперація(бінарна.Тип, ПерезаписатиАдреси(бінарна.Вираз1), ПерезаписатиАдреси(бінарна.Вираз2)),
                АдресаПамяти адресаПамяти => адресаПамяти.адреса switch
                {
                    Регістр => адресаПамяти,
                    Константа константа when константа.значення == Із8РічноїАдреси(0) => new Число(0),

                    Константа константа when константа.значення == Із8РічноїАдреси(2) => new Ідентифікатор("парам"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3) => new Ідентифікатор("рез"),
                    Константа константа when константа.значення == Із8РічноїАдреси(4) => new Ідентифікатор("тимч1"),
                    Константа константа when константа.значення == Із8РічноїАдреси(5) => new Ідентифікатор("тимч2"),
                    Константа константа when константа.значення == Із8РічноїАдреси(6) => new Ідентифікатор("тимч3"),

                    Константа константа when константа.значення == Із8РічноїАдреси(3010) => new Ідентифікатор("ДваУМінус16Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3011) => new Ідентифікатор("ДваУМінус28Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3012) => new Ідентифікатор("ДваУМінус40Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3017) => new Ідентифікатор("ДваУМінус15Ступіні"),

                    Константа константа when константа.значення == Із8РічноїАдреси(3020) => new Ідентифікатор("ДваУМінус27Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3021) => new Ідентифікатор("ДваУМінус39Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3025) => new Ідентифікатор("Мінус15_16их"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3026) => new Ідентифікатор("МінусНуль"),
                    
                    Константа константа when константа.значення == Із8РічноїАдреси(3035) => new Ідентифікатор("МашиннаОдиниця"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3036) => new Ідентифікатор("МінусМашиннаОдиниця"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3037) => new Ідентифікатор("Log10_2"),

                    Константа константа when константа.значення == Із8РічноїАдреси(3040) => new Ідентифікатор("ДваУМінус12Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3041) => new Ідентифікатор("ДваУМінус24Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3042) => new Ідентифікатор("ДваУМінус1Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3043) => new Ідентифікатор("ДваУМінус2Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3044) => new Ідентифікатор("ДваУМінус3Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3045) => new Ідентифікатор("ДваУМінус4Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3046) => new Ідентифікатор("ДваУМінус6Ступіні"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3047) => new Ідентифікатор("ДваУМінус36Ступіні"),

                    Константа константа when константа.значення == Із8РічноїАдреси(3050) => new Ідентифікатор("Плюс10_16их"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3051) => new Ідентифікатор("Ln2"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3052) => new Ідентифікатор("ОднаДесята"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3053) => new Ідентифікатор("ОднаСота"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3054) => new Ідентифікатор("ОднаТисячна"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3055) => new Ідентифікатор("ДвіДесятих"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3056) => new Ідентифікатор("ТриДесятих"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3057) => new Ідентифікатор("ВісімДесятих"),

                    Константа константа when константа.значення == Із8РічноїАдреси(3060) => new Ідентифікатор("ДвіТисячних"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3061) => new Ідентифікатор("ШіснадцятьСотих"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3062) => new Ідентифікатор("ТридьцятьДвіСотих"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3063) => new Ідентифікатор("ОдиницяНаПі"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3064) => new Ідентифікатор("ОдиницяНаКоріньІзПі"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3065) => new Ідентифікатор("ОдиницяНаЕ"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3066) => new Ідентифікатор("ПіНаЧотири"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3067) => new Ідентифікатор("ДваНаПі"),

                    Константа константа when константа.значення == Із8РічноїАдреси(3070) => new Ідентифікатор("КоріньДвійкиНаДва"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3071) => new Ідентифікатор("ОдинНаКоріньІзТрьох"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3072) => new Ідентифікатор("ЕНаТри"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3073) => new Ідентифікатор("ОдинНаКоріньІзДваПі"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3074) => new Ідентифікатор("ЕНаЧотири"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3075) => new Ідентифікатор("ОднаТретя"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3076) => new Ідентифікатор("ОдинНаПіКвадрат"),
                    Константа константа when константа.значення == Із8РічноїАдреси(3077) => new Ідентифікатор("Lg_E"),
                    _ => адресаПамяти
                },
                _ => вираз,
            };
        }
    }
    private static Операція ПерезаписатиВирази(Операція операція, Func<Вираз, Вираз> перезаписувач)
    {
        switch (операція)
        {
            case ЗберіганняЗмінної зберіганняЗмінної:
                return new ЗберіганняЗмінної(перезаписувач(зберіганняЗмінної.МісцеЗберігання), перезаписувач(зберіганняЗмінної.Що));
            case УмовнаОперація умовнаОперація:
                return new УмовнаОперація(перезаписувач(умовнаОперація.Умова), ПерезаписатиВирази(умовнаОперація.Що, перезаписувач));
            case УмовнаОперація2 умовнаОперація:
                return new УмовнаОперація2(перезаписувач(умовнаОперація.Умова), ПерезаписатиВирази(умовнаОперація.Що, перезаписувач), ПерезаписатиВирази(умовнаОперація.Інакше, перезаписувач));
            case ДвіОперації двіОперації:
                return new ДвіОперації(ПерезаписатиВирази(двіОперації.Операція1, перезаписувач), ПерезаписатиВирази(двіОперації.Операція2, перезаписувач));
            case Перехід:
            case Повернутися:
            case ВстановитиТочкуПовернення:
            case ВвідЧисел:
            case ВвідКодів:
            case ВивідКодів:
            case ЗаписатиКодаНаБарабан:
            case ПрочитатиКодаІзБарабана:
            case ПідготуватиБарабан:
            case Стоп:
                return операція;
            default:
                throw new NotSupportedException();
        };
    }
    private static string ДоРядка(Операція операція)
    {
        return string.Join(Environment.NewLine, операція.ToString().ReplaceLineEndings().Split(Environment.NewLine).Вибрати(x => "    " + x));
    }

    private static IEnumerable<Операція> ДоАссемблера(СтруктураКоманди команда, bool html)
    {
        switch (команда.Код)
        {
            case КодОперації.Сложение:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.Додавання, команда);
                break;
            case КодОперації.Вычитание:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.Віднімання, команда);
                break;
            case КодОперації.СложениеКоманд:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.ДодаванняКоманд, команда);
                break;
            case КодОперації.СравнениеСУчетомЗнаков:
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.МеншеЧиДорівнює,
                        ВідноснаПамять(команда.Адреса1),
                        ВідноснаПамять(команда.Адреса2)),
                    new Перехід(команда.Адреса3));
                break;
            case КодОперації.СравнениеБезУчетаЗнаков:
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.МеншеЧиДорівнює,
                        new УнарнаОперація(ТипУнарноїОперації.Модуль, ВідноснаПамять(команда.Адреса1)),
                        new УнарнаОперація(ТипУнарноїОперації.Модуль, ВідноснаПамять(команда.Адреса2))),
                    new Перехід(команда.Адреса3));
                break;
            case КодОперації.ВычитаниеПоМодулю:
                yield return new ЗберіганняЗмінної(
                    ВідноснаПамять(команда.Адреса3),
                    new БінарнаОперація(ТипБінарноїОперації.Віднімання,
                        new УнарнаОперація(ТипУнарноїОперації.Модуль, ВідноснаПамять(команда.Адреса1)),
                        new УнарнаОперація(ТипУнарноїОперації.Модуль, ВідноснаПамять(команда.Адреса2))));
                break;
            case КодОперації.ЦиклическоеСложение:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.ЦиклічнеДодавання, команда);
                break;
            case КодОперації.УмножениеБезОкругления:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.МноженняБезСкругленням, команда);
                break;
            case КодОперації.УмножениеСОкруглением:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.Множення, команда);
                break;
            case КодОперації.Деление:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.Ділення, команда);
                break;
            case КодОперації.ЛогическийСдвиг:
                yield return new УмовнаОперація2(
                    new БінарнаОперація(ТипБінарноїОперації.МеншеЧиДорівнює,
                        ВідноснаПамять(команда.Адреса1),
                        new Константа(0)),
                    new ЗберіганняЗмінної(
                        ВідноснаПамять(команда.Адреса3),
                        new БінарнаОперація(ТипБінарноїОперації.СдвигВправо, ВідноснаПамять(команда.Адреса1), new УнарнаОперація(ТипУнарноїОперації.Модуль, ВідноснаПамять(команда.Адреса2)))),
                    new ЗберіганняЗмінної(
                        ВідноснаПамять(команда.Адреса3),
                        new БінарнаОперація(ТипБінарноїОперації.СдвигВліво, ВідноснаПамять(команда.Адреса1), ВідноснаПамять(команда.Адреса2))));
                break;
            case КодОперації.ЛогическоеСложение:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.ЛогічнеДодавання, команда);
                break;
            case КодОперації.ЛогическоеУмножение:
                yield return СтворитиБінарнуОперацію(ТипБінарноїОперації.ЛогічнеМноження, команда);
                break;
            case КодОперації.ТочноеСравнение:
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.Дорівнює, ВідноснаПамять(команда.Адреса1), ВідноснаПамять(команда.Адреса2)),
                    new Перехід(команда.Адреса3));
                break;
            case КодОперації.ОперацияРавнозначно:
                yield return new ЗберіганняЗмінної(
                    ВідноснаПамять(команда.Адреса3),
                    new БінарнаОперація(ТипБінарноїОперації.ЛогічнеМноження, new УнарнаОперація(ТипУнарноїОперації.БітовеНі, СтворитиБінарнийВираз(ТипБінарноїОперації.ЛогічнаВиключнеАбо, команда)), new Число(ulong.MaxValue >> 23)));
                break;
            case КодОперації.ВводЧисел:
                yield return new ВвідЧисел(команда.Адреса1, команда.Адреса2);
                yield return new Перехід(команда.Адреса3);
                break;
            case КодОперації.ВводКоманд:
                yield return new ВвідКодів(команда.Адреса1, команда.Адреса2);
                yield return new Перехід(команда.Адреса3);
                break;
            case КодОперації.ВыводКодов:
                yield return new ВивідКодів(команда.Адреса1, команда.Адреса2);
                yield return new Перехід(команда.Адреса3);
                break;
            case КодОперації.ЗаписьНаМагнитныйБарабанКодовИзЯчеекЗапоминающегоУстройств:
                yield return new ЗаписатиКодаНаБарабан(команда.Адреса1, команда.Адреса2);
                yield return new Перехід(команда.Адреса3);
                break;
            case КодОперації.ЧтениеКодовСМагнитногоБарабанаВЯчейкиЗапоминающегоУстройства:
                yield return new ПрочитатиКодаІзБарабана(команда.Адреса1, команда.Адреса2);
                yield return new Перехід(команда.Адреса3);
                break;
            case КодОперації.ОбращениеКМагнитномуБарабану:
                yield return new ПідготуватиБарабан(команда.Адреса1, команда.Адреса2, команда.Адреса3);
                break;
            case КодОперації.НачалоГрупповойОперации:
                yield return new ЗберіганняЗмінної(
                    new Регістр(ТипРегістра.Ц),
                    ВідноснаАдреса(команда.Адреса1));
                yield return new ЗберіганняЗмінної(
                    new Регістр(ТипРегістра.А),
                    ВідноснаАдреса(команда.Адреса2));
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.Дорівнює, new Регістр(ТипРегістра.Ц), new Регістр(ТипРегістра.А)),
                    new Перехід(команда.Адреса3));
                break;
            case КодОперації.ОкончаниеГрупповойОперации:
                yield return new ЗберіганняЗмінної(
                    new Регістр(ТипРегістра.А),
                    new БінарнаОперація(ТипБінарноїОперації.Додавання, new Регістр(ТипРегістра.А), new Константа(БазоваАдреса(команда.Адреса1))));
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.Дорівнює, new Регістр(ТипРегістра.Ц), new Регістр(ТипРегістра.А)),
                    new Перехід(команда.Адреса3));
                yield return new Перехід(команда.Адреса2);
                break;
            case КодОперації.УсловныйПереходНаПодпрограмму:
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.МеншеЧиДорівнює,
                        ВідноснаПамять(команда.Адреса1),
                        new Константа(0)),
                    new ДвіОперації(new ВстановитиТочкуПовернення(команда.Адреса2), new Перехід(команда.Адреса3)));
                break;
            case КодОперації.УсловныйПереходПоЗнакуЧисла:
                yield return new УмовнаОперація(
                    new БінарнаОперація(ТипБінарноїОперації.МеншеЧиДорівнює,
                        ВідноснаПамять(команда.Адреса1),
                        new Константа(0)),
                    new Перехід(команда.Адреса3));
                yield return new Перехід(команда.Адреса2);
                break;
            case КодОперації.ПереходПоРегиструВозврата:
                yield return new Повернутися();
                break;
            case КодОперації.ОстановМашины:
                yield return new Стоп();
                break;
            case КодОперації.ПереходПоФиксатору:
                yield return new ЗберіганняЗмінної(
                    new Регістр(ТипРегістра.А),
                    ВідноснаПамять(команда.Адреса1));
                yield return new ЗберіганняЗмінної(
                    ВідноснаПамять(команда.Адреса3),
                    new АдресаПамяти(new Регістр(ТипРегістра.А)));
                break;
            default:
                throw new NotSupportedException();
        }
    }

    private static Операція СтворитиБінарнуОперацію(ТипБінарноїОперації тип, СтруктураКоманди команда)
    {
        return new ЗберіганняЗмінної(
            ВідноснаПамять(команда.Адреса3),
            СтворитиБінарнийВираз(тип, команда));
    }

    private static Вираз СтворитиБінарнийВираз(ТипБінарноїОперації тип, СтруктураКоманди команда)
    {
        return new БінарнаОперація(тип, ВідноснаПамять(команда.Адреса1), ВідноснаПамять(команда.Адреса2));
    }

    private static Вираз ВідноснаАдреса(int адреса)
    {
        var базоваАдреса = БазоваАдреса(адреса);
        if ((адреса & (1 << 11)) != 0)
        {
            return new БінарнаОперація(ТипБінарноїОперації.Додавання, new Константа(базоваАдреса), new Регістр(ТипРегістра.А));
        }

        return new Константа(базоваАдреса);
    }

    private static int БазоваАдреса(int адреса)
    {
        var базоваАдреса = адреса & 0x7FF;
        return базоваАдреса;
    }

    private static АдресаПамяти ВідноснаПамять(int адреса)
    {
        return new АдресаПамяти(ВідноснаАдреса(адреса));
    }
}

abstract record Операція();
abstract record Вираз();
enum ТипУнарноїОперації
{
    Модуль,
    БітовеНі,
}
record УнарнаОперація(ТипУнарноїОперації Тип, Вираз Вираз) : Вираз
{
    public override string ToString()
    {
        switch (Тип)
        {
            case ТипУнарноїОперації.Модуль:
                return $"|{Вираз}|";
            case ТипУнарноїОперації.БітовеНі:
                return $"~({Вираз})";
            default:
                throw new NotImplementedException($"Невідомий тип унарної операції {Тип}");
    }
}
}
enum ТипБінарноїОперації
{
    Додавання,
    Віднімання,
    Множення,
    Ділення,
    ДодаванняКоманд,
    ЦиклічнеДодавання,
    МноженняБезСкругленням,

    Дорівнює,
    МеншеЧиДорівнює,

    ЛогічнеДодавання,
    ЛогічнеМноження,
    ЛогічнаВиключнеАбо,
    СдвигВправо,
    СдвигВліво,
}
record БінарнаОперація(ТипБінарноїОперації Тип, Вираз Вираз1, Вираз Вираз2): Вираз
{
    public override string ToString()
    {
        return $"{В(Вираз1)} {ТипОперації()} {В(Вираз2)}";
    }

    private static string В(Вираз вираз)
    {
        if (вираз is БінарнаОперація) return $"({вираз})";
        if (вираз is УнарнаОперація) return $"({вираз})";
        return $"{вираз}";
    }

    private string ТипОперації()
    {
        switch(Тип)
        {
            case ТипБінарноїОперації.Додавання:
                return "+";
            case ТипБінарноїОперації.Віднімання:
                return "-";
            case ТипБінарноїОперації.Множення:
                return "*";
            case ТипБінарноїОперації.Ділення:
                return "/";
            case ТипБінарноїОперації.МноженняБезСкругленням:
                return "|*|";
            case ТипБінарноїОперації.ДодаванняКоманд:
                return "ДодК";
            case ТипБінарноїОперації.ЦиклічнеДодавання:
                return "ДодЦ";

            case ТипБінарноїОперації.Дорівнює:
                return "==";
            case ТипБінарноїОперації.МеншеЧиДорівнює:
                return "<=";

            case ТипБінарноїОперації.ЛогічнеДодавання:
                return "|";
            case ТипБінарноїОперації.ЛогічнеМноження:
                return "&";
            case ТипБінарноїОперації.ЛогічнаВиключнеАбо:
                return "^";

            case ТипБінарноїОперації.СдвигВліво:
                return "<<";
            case ТипБінарноїОперації.СдвигВправо:
                return ">>";
            default:
                throw new NotImplementedException($"Невідомий тип бінарної операції {Тип}");
        }
    }
};
record ЗберіганняЗмінної(Вираз МісцеЗберігання, Вираз Що) : Операція
{
    public override string ToString()
    {
        return $"{МісцеЗберігання} = {Що};";
    }
};
record УмовнаОперація(Вираз Умова, Операція Що) : Операція
{
    public override string ToString()
    {
        return $"if ({Умова})\n{{\n    {Що}\n}}";
    }
};
record УмовнаОперація2(Вираз Умова, Операція Що, Операція Інакше) : Операція
{
    public override string ToString()
    {
        return $"if ({Умова})\n{{\n    {Що}\n}}\nelse\n{{\n   {Інакше}\n}}";
    }
};
record ДвіОперації(Операція Операція1, Операція Операція2) : Операція
{
    public override string ToString()
    {
        return $"{Операція1} {Операція2}";
    }
}
record Перехід(int адреса) : Операція
{
    public override string ToString()
    {
        return $"goto lbl_{До8РічноїАдреси(адреса)};";
    }
}
record Повернутися() : Операція
{
    public override string ToString()
    {
        return $"lngjmp;";
    }
};
record ВстановитиТочкуПовернення(int адреса) : Операція
{
    public override string ToString()
    {
        return $"setjmp {До8РічноїАдреси(адреса)};";
    }
}

record Ідентифікатор(string назва) : Вираз
{
    public override string ToString()
    {
        return назва;
    }
};

record Константа(int значення) : Вираз
{
    public override string ToString()
    {
        return $"{До8РічноїАдреси(значення)}";
    }
};
record Число(ulong значення) : Вираз
{
    public override string ToString()
    {
        return $"0x{значення:X}";
    }
};
record АдресаПамяти(Вираз адреса) : Вираз
{
    public override string ToString()
    {
        if (адреса is Регістр)
        {
            return $"п[{адреса}]";
        }

        return $"п[{адреса}]";
    }
};
enum ТипРегістра
{
    С,
    К,
    Р,
    Ц,
    А,
}
record Регістр(ТипРегістра регістр) : Вираз
{
    public override string ToString()
    {
        return регістр.ToString();
    }
};
record ВвідЧисел(int від, int по) : Операція
{
    public override string ToString()
    {
        return $"inputNumbers({До8РічноїАдреси(від)}, {До8РічноїАдреси(по)})";
    }
};
record ВвідКодів(int від, int по) : Операція
{
    public override string ToString()
    {
        return $"inputCodes({До8РічноїАдреси(від)}, {До8РічноїАдреси(по)})";
    }
};

record ВивідКодів(int від, int по) : Операція
{
    public override string ToString()
    {
        return $"printCodes({До8РічноїАдреси(від)}, {До8РічноїАдреси(по)})";
    }
};
record ЗаписатиКодаНаБарабан(int від, int по) : Операція
{
    public override string ToString()
    {
        return $"writeCodesToReel({До8РічноїАдреси(від)}, {До8РічноїАдреси(по)})";
    }
};
record ПрочитатиКодаІзБарабана(int від, int по) : Операція
{
    public override string ToString()
    {
        return $"readCodesFromReel({До8РічноїАдреси(від)}, {До8РічноїАдреси(по)})";
    }
};
record ПідготуватиБарабан(int тип, int адреса, int барабан) : Операція
{
    public override string ToString()
    {
        return $"prepareReel({тип}, {адреса}, {барабан})";
    }
};
record Стоп() : Операція
{
    public override string ToString()
    {
        return "exit();";
    }
};